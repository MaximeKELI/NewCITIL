<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complet Dashboard Admin - CITIL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffeaea; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .btn { background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #1976d2; }
        .btn-success { background: #4caf50; }
        .btn-warning { background: #ff9800; }
        .btn-danger { background: #f44336; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .loading { color: #666; font-style: italic; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .test-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .detailed-log { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Test Complet et Rigoureux - Dashboard Administrateur CITIL</h1>
        <p><strong>Objectif :</strong> Tester exhaustivement toutes les fonctionnalit√©s du dashboard administrateur avec une approche m√©thodique et logique.</p>
        
        <div class="test-section info">
            <h3>üìã Plan de Test</h3>
            <ol>
                <li><strong>Authentification Admin</strong> - Connexion et gestion des sessions</li>
                <li><strong>Dashboard Overview</strong> - Statistiques et m√©triques</li>
                <li><strong>Gestion des Produits</strong> - CRUD complet</li>
                <li><strong>Gestion des Formations</strong> - CRUD complet</li>
                <li><strong>Gestion des Cat√©gories</strong> - CRUD complet</li>
                <li><strong>Gestion des Utilisateurs</strong> - Liste et permissions</li>
                <li><strong>Gestion des Candidatures</strong> - Suivi et statuts</li>
                <li><strong>Interface Utilisateur</strong> - Navigation et UX</li>
                <li><strong>Gestion des Erreurs</strong> - Robustesse et feedback</li>
                <li><strong>Performance</strong> - Temps de r√©ponse et optimisation</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üéØ Contr√¥les de Test</h3>
            <button class="btn" onclick="runAllTests()">üöÄ Lancer Tous les Tests</button>
            <button class="btn btn-success" onclick="runQuickTest()">‚ö° Test Rapide</button>
            <button class="btn btn-warning" onclick="runStressTest()">üí™ Test de Stress</button>
            <button class="btn btn-danger" onclick="clearResults()">üóëÔ∏è Effacer R√©sultats</button>
        </div>

        <div class="test-grid">
            <!-- Test 1: Authentification -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="auth-indicator"></span>1. Authentification Admin</h4>
                <button class="btn" onclick="testAuthentication()">Tester Auth</button>
                <div id="auth-result" class="result"></div>
            </div>

            <!-- Test 2: Dashboard Overview -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="dashboard-indicator"></span>2. Dashboard Overview</h4>
                <button class="btn" onclick="testDashboard()">Tester Dashboard</button>
                <div id="dashboard-result" class="result"></div>
            </div>

            <!-- Test 3: Gestion Produits -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="products-indicator"></span>3. Gestion Produits</h4>
                <button class="btn" onclick="testProducts()">Tester Produits</button>
                <div id="products-result" class="result"></div>
            </div>

            <!-- Test 4: Gestion Formations -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="trainings-indicator"></span>4. Gestion Formations</h4>
                <button class="btn" onclick="testTrainings()">Tester Formations</button>
                <div id="trainings-result" class="result"></div>
            </div>

            <!-- Test 5: Gestion Cat√©gories -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="categories-indicator"></span>5. Gestion Cat√©gories</h4>
                <button class="btn" onclick="testCategories()">Tester Cat√©gories</button>
                <div id="categories-result" class="result"></div>
            </div>

            <!-- Test 6: Gestion Utilisateurs -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="users-indicator"></span>6. Gestion Utilisateurs</h4>
                <button class="btn" onclick="testUsers()">Tester Utilisateurs</button>
                <div id="users-result" class="result"></div>
            </div>

            <!-- Test 7: Gestion Candidatures -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="applications-indicator"></span>7. Gestion Candidatures</h4>
                <button class="btn" onclick="testApplications()">Tester Candidatures</button>
                <div id="applications-result" class="result"></div>
            </div>

            <!-- Test 8: Interface Utilisateur -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="ui-indicator"></span>8. Interface Utilisateur</h4>
                <button class="btn" onclick="testUI()">Tester UI</button>
                <div id="ui-result" class="result"></div>
            </div>

            <!-- Test 9: Gestion Erreurs -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="errors-indicator"></span>9. Gestion Erreurs</h4>
                <button class="btn" onclick="testErrorHandling()">Tester Erreurs</button>
                <div id="errors-result" class="result"></div>
            </div>

            <!-- Test 10: Performance -->
            <div class="test-item">
                <h4><span class="status-indicator status-pending" id="performance-indicator"></span>10. Performance</h4>
                <button class="btn" onclick="testPerformance()">Tester Performance</button>
                <div id="performance-result" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä R√©sultats Globaux</h3>
            <div id="global-results" class="result">
                <div class="loading">En attente des tests...</div>
            </div>
            <div id="detailed-log" class="detailed-log" style="display: none;">
                <h4>üìù Log D√©taill√©</h4>
                <div id="log-content"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8002';
        let authToken = null;
        let testResults = {};
        let detailedLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            detailedLog.push(logEntry);
            console.log(logEntry);
        }

        function updateIndicator(testId, status) {
            const indicator = document.getElementById(`${testId}-indicator`);
            indicator.className = `status-indicator status-${status}`;
        }

        function updateResult(testId, content, type = 'info') {
            const resultDiv = document.getElementById(`${testId}-result`);
            resultDiv.innerHTML = `<div class="${type}">${content}</div>`;
        }

        async function makeRequest(url, options = {}) {
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3002',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                log(`Request to ${url}: ${response.status} (${duration}ms)`, response.ok ? 'success' : 'error');
                
                return { 
                    success: response.ok, 
                    data, 
                    status: response.status, 
                    duration 
                };
            } catch (error) {
                const duration = Date.now() - startTime;
                log(`Request to ${url} failed: ${error.message} (${duration}ms)`, 'error');
                return { success: false, error: error.message, duration };
            }
        }

        // Test 1: Authentification
        async function testAuthentication() {
            updateIndicator('auth', 'pending');
            updateResult('auth', '<div class="loading">Test d\'authentification...</div>');
            
            const tests = [
                { name: 'Connexion admin', test: async () => {
                    const result = await makeRequest('/api/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ email: 'admin@citil.com', password: 'admin123' })
                    });
                    if (result.success && result.data.success) {
                        authToken = result.data.token;
                        return { success: true, message: 'Connexion r√©ussie' };
                    }
                    return { success: false, message: result.data?.message || '√âchec de connexion' };
                }},
                { name: 'V√©rification token', test: async () => {
                    if (!authToken) return { success: false, message: 'Aucun token disponible' };
                    const result = await makeRequest('/api/auth/me');
                    return { 
                        success: result.success, 
                        message: result.success ? 'Token valide' : 'Token invalide' 
                    };
                }},
                { name: 'D√©connexion', test: async () => {
                    // Simuler d√©connexion
                    authToken = null;
                    return { success: true, message: 'D√©connexion simul√©e' };
                }}
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push(`${test.name}: ${result.success ? '‚úÖ' : '‚ùå'} ${result.message}`);
                } catch (error) {
                    results.push(`${test.name}: ‚ùå Erreur - ${error.message}`);
                }
            }

            const allSuccess = results.every(r => r.includes('‚úÖ'));
            updateIndicator('auth', allSuccess ? 'success' : 'error');
            updateResult('auth', results.join('<br>'), allSuccess ? 'success' : 'error');
            testResults.auth = { success: allSuccess, results };
        }

        // Test 2: Dashboard Overview
        async function testDashboard() {
            updateIndicator('dashboard', 'pending');
            updateResult('dashboard', '<div class="loading">Test du dashboard...</div>');
            
            const tests = [
                { name: 'R√©cup√©ration produits', test: () => makeRequest('/api/products') },
                { name: 'R√©cup√©ration formations', test: () => makeRequest('/api/trainings') },
                { name: 'R√©cup√©ration utilisateurs', test: () => makeRequest('/api/admin/users') },
                { name: 'R√©cup√©ration candidatures', test: () => makeRequest('/api/admin/internship-applications') }
            ];

            let results = [];
            let totalDuration = 0;
            
            for (const test of tests) {
                try {
                    const result = await test.test();
                    totalDuration += result.duration || 0;
                    results.push(`${test.name}: ${result.success ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)`);
                } catch (error) {
                    results.push(`${test.name}: ‚ùå Erreur - ${error.message}`);
                }
            }

            const allSuccess = results.every(r => r.includes('‚úÖ'));
            updateIndicator('dashboard', allSuccess ? 'success' : 'error');
            updateResult('dashboard', `${results.join('<br>')}<br><strong>Dur√©e totale: ${totalDuration}ms</strong>`, allSuccess ? 'success' : 'error');
            testResults.dashboard = { success: allSuccess, results, duration: totalDuration };
        }

        // Test 3: Gestion Produits
        async function testProducts() {
            updateIndicator('products', 'pending');
            updateResult('products', '<div class="loading">Test de gestion des produits...</div>');
            
            const tests = [
                { name: 'Liste produits', test: () => makeRequest('/api/products') },
                { name: 'Cr√©ation produit', test: () => makeRequest('/api/admin/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'Test Produit Admin',
                        description: 'Description test',
                        price: 15000,
                        stock: 5,
                        category_id: 1,
                        reference: 'ADMIN-TEST-001'
                    })
                })},
                { name: 'Cat√©gories disponibles', test: () => makeRequest('/api/categories') }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push(`${test.name}: ${result.success ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)`);
                } catch (error) {
                    results.push(`${test.name}: ‚ùå Erreur - ${error.message}`);
                }
            }

            const allSuccess = results.every(r => r.includes('‚úÖ'));
            updateIndicator('products', allSuccess ? 'success' : 'error');
            updateResult('products', results.join('<br>'), allSuccess ? 'success' : 'error');
            testResults.products = { success: allSuccess, results };
        }

        // Test 4: Gestion Formations
        async function testTrainings() {
            updateIndicator('trainings', 'pending');
            updateResult('trainings', '<div class="loading">Test de gestion des formations...</div>');
            
            const tests = [
                { name: 'Liste formations', test: () => makeRequest('/api/trainings') },
                { name: 'Cr√©ation formation', test: () => makeRequest('/api/admin/trainings', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: 'Formation Test Admin',
                        description: 'Description formation test',
                        price: 25000,
                        duration_hours: 16,
                        start_date: '2025-11-01',
                        schedule: '9h-17h'
                    })
                })}
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push(`${test.name}: ${result.success ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)`);
                } catch (error) {
                    results.push(`${test.name}: ‚ùå Erreur - ${error.message}`);
                }
            }

            const allSuccess = results.every(r => r.includes('‚úÖ'));
            updateIndicator('trainings', allSuccess ? 'success' : 'error');
            updateResult('trainings', results.join('<br>'), allSuccess ? 'success' : 'error');
            testResults.trainings = { success: allSuccess, results };
        }

        // Test 5: Gestion Cat√©gories
        async function testCategories() {
            updateIndicator('categories', 'pending');
            updateResult('categories', '<div class="loading">Test de gestion des cat√©gories...</div>');
            
            const tests = [
                { name: 'Liste cat√©gories', test: () => makeRequest('/api/categories') },
                { name: 'Cr√©ation cat√©gorie', test: () => makeRequest('/api/admin/categories', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'Cat√©gorie Test Admin',
                        description: 'Description cat√©gorie test'
                    })
                })}
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push(`${test.name}: ${result.success ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)`);
                } catch (error) {
                    results.push(`${test.name}: ‚ùå Erreur - ${error.message}`);
                }
            }

            const allSuccess = results.every(r => r.includes('‚úÖ'));
            updateIndicator('categories', allSuccess ? 'success' : 'error');
            updateResult('categories', results.join('<br>'), allSuccess ? 'success' : 'error');
            testResults.categories = { success: allSuccess, results };
        }

        // Test 6: Gestion Utilisateurs
        async function testUsers() {
            updateIndicator('users', 'pending');
            updateResult('users', '<div class="loading">Test de gestion des utilisateurs...</div>');
            
            const result = await makeRequest('/api/admin/users');
            const success = result.success;
            
            updateIndicator('users', success ? 'success' : 'error');
            updateResult('users', `Liste utilisateurs: ${success ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)<br>
                ${success ? `Nombre d'utilisateurs: ${result.data.length}` : 'Erreur de r√©cup√©ration'}`, 
                success ? 'success' : 'error');
            testResults.users = { success, results: [result] };
        }

        // Test 7: Gestion Candidatures
        async function testApplications() {
            updateIndicator('applications', 'pending');
            updateResult('applications', '<div class="loading">Test de gestion des candidatures...</div>');
            
            const result = await makeRequest('/api/admin/internship-applications');
            const success = result.success;
            
            updateIndicator('applications', success ? 'success' : 'error');
            updateResult('applications', `Liste candidatures: ${success ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)<br>
                ${success ? `Nombre de candidatures: ${result.data.length}` : 'Erreur de r√©cup√©ration'}`, 
                success ? 'success' : 'error');
            testResults.applications = { success, results: [result] };
        }

        // Test 8: Interface Utilisateur
        async function testUI() {
            updateIndicator('ui', 'pending');
            updateResult('ui', '<div class="loading">Test de l'interface utilisateur...</div>');
            
            // Test de connectivit√© frontend
            try {
                const response = await fetch('http://localhost:3002', { method: 'HEAD' });
                const success = response.ok;
                updateIndicator('ui', success ? 'success' : 'error');
                updateResult('ui', `Frontend accessible: ${success ? '‚úÖ' : '‚ùå'}<br>
                    Status: ${response.status}<br>
                    Interface utilisateur: ${success ? 'Op√©rationnelle' : 'Inaccessible'}`, 
                    success ? 'success' : 'error');
                testResults.ui = { success, results: [{ success, status: response.status }] };
            } catch (error) {
                updateIndicator('ui', 'error');
                updateResult('ui', `Frontend accessible: ‚ùå<br>Erreur: ${error.message}`, 'error');
                testResults.ui = { success: false, results: [{ success: false, error: error.message }] };
            }
        }

        // Test 9: Gestion Erreurs
        async function testErrorHandling() {
            updateIndicator('errors', 'pending');
            updateResult('errors', '<div class="loading">Test de gestion des erreurs...</div>');
            
            const tests = [
                { name: 'Endpoint inexistant', test: () => makeRequest('/api/nonexistent') },
                { name: 'M√©thode non autoris√©e', test: () => makeRequest('/api/products', { method: 'DELETE' }) },
                { name: 'Donn√©es invalides', test: () => makeRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email: 'invalid', password: 'wrong' })
                })}
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    // Pour les tests d'erreur, on s'attend √† ce qu'ils √©chouent
                    const expectedFailure = !result.success;
                    results.push(`${test.name}: ${expectedFailure ? '‚úÖ' : '‚ùå'} (${result.duration || 0}ms)`);
                } catch (error) {
                    results.push(`${test.name}: ‚úÖ Erreur g√©r√©e correctement`);
                }
            }

            updateIndicator('errors', 'success');
            updateResult('errors', results.join('<br>'), 'success');
            testResults.errors = { success: true, results };
        }

        // Test 10: Performance
        async function testPerformance() {
            updateIndicator('performance', 'pending');
            updateResult('performance', '<div class="loading">Test de performance...</div>');
            
            const tests = [
                { name: 'API Products', test: () => makeRequest('/api/products') },
                { name: 'API Trainings', test: () => makeRequest('/api/trainings') },
                { name: 'API Categories', test: () => makeRequest('/api/categories') },
                { name: 'API Users', test: () => makeRequest('/api/admin/users') }
            ];

            let results = [];
            let totalDuration = 0;
            let maxDuration = 0;
            
            for (const test of tests) {
                try {
                    const result = await test.test();
                    const duration = result.duration || 0;
                    totalDuration += duration;
                    maxDuration = Math.max(maxDuration, duration);
                    results.push(`${test.name}: ${result.success ? '‚úÖ' : '‚ùå'} ${duration}ms`);
                } catch (error) {
                    results.push(`${test.name}: ‚ùå Erreur`);
                }
            }

            const avgDuration = totalDuration / tests.length;
            const performance = avgDuration < 1000 ? 'excellent' : avgDuration < 2000 ? 'bon' : 'm√©diocre';
            
            updateIndicator('performance', 'success');
            updateResult('performance', `${results.join('<br>')}<br>
                <strong>Dur√©e moyenne: ${avgDuration.toFixed(0)}ms</strong><br>
                <strong>Dur√©e max: ${maxDuration}ms</strong><br>
                <strong>Performance: ${performance}</strong>`, 'success');
            testResults.performance = { success: true, results, avgDuration, maxDuration };
        }

        // Fonctions de contr√¥le
        async function runAllTests() {
            log('D√©marrage des tests complets', 'info');
            clearResults();
            
            await testAuthentication();
            await testDashboard();
            await testProducts();
            await testTrainings();
            await testCategories();
            await testUsers();
            await testApplications();
            await testUI();
            await testErrorHandling();
            await testPerformance();
            
            updateGlobalResults();
            log('Tests complets termin√©s', 'info');
        }

        async function runQuickTest() {
            log('D√©marrage du test rapide', 'info');
            clearResults();
            
            await testAuthentication();
            await testDashboard();
            await testUI();
            
            updateGlobalResults();
            log('Test rapide termin√©', 'info');
        }

        async function runStressTest() {
            log('D√©marrage du test de stress', 'info');
            clearResults();
            
            // Test de charge - 10 requ√™tes simultan√©es
            const promises = [];
            for (let i = 0; i < 10; i++) {
                promises.push(makeRequest('/api/products'));
            }
            
            const results = await Promise.all(promises);
            const successCount = results.filter(r => r.success).length;
            
            updateIndicator('performance', 'success');
            updateResult('performance', `Test de stress: ${successCount}/10 requ√™tes r√©ussies`, 'success');
            
            updateGlobalResults();
            log('Test de stress termin√©', 'info');
        }

        function clearResults() {
            testResults = {};
            detailedLog = [];
            document.getElementById('global-results').innerHTML = '<div class="loading">En attente des tests...</div>';
            document.getElementById('detailed-log').style.display = 'none';
            
            // Reset all indicators
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-pending';
            });
        }

        function updateGlobalResults() {
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success).length;
            const successRate = totalTests > 0 ? (successfulTests / totalTests * 100).toFixed(1) : 0;
            
            const summary = `
                <h4>üìä R√©sum√© des Tests</h4>
                <p><strong>Tests ex√©cut√©s:</strong> ${totalTests}</p>
                <p><strong>Tests r√©ussis:</strong> ${successfulTests}</p>
                <p><strong>Taux de r√©ussite:</strong> ${successRate}%</p>
                <p><strong>Status global:</strong> ${successRate >= 80 ? '‚úÖ Excellent' : successRate >= 60 ? '‚ö†Ô∏è Acceptable' : '‚ùå Probl√©matique'}</p>
            `;
            
            document.getElementById('global-results').innerHTML = summary;
            document.getElementById('detailed-log').style.display = 'block';
            document.getElementById('log-content').innerHTML = detailedLog.join('<br>');
        }

        // Test automatique au chargement
        window.onload = function() {
            log('Page de test charg√©e', 'info');
            setTimeout(() => {
                log('D√©marrage automatique des tests', 'info');
                runQuickTest();
            }, 1000);
        };
    </script>
</body>
</html>
