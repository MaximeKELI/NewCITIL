<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Dashboard Admin - CITIL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffeaea; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .btn { background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #1976d2; }
        .btn-success { background: #4caf50; }
        .btn-warning { background: #ff9800; }
        .btn-danger { background: #f44336; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .test-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fafafa; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .iframe-container { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test Final Dashboard Admin - CITIL</h1>
        <p><strong>Objectif :</strong> V√©rifier que tous les composants du dashboard administrateur s'affichent et fonctionnent correctement.</p>
        
        <div class="test-section info">
            <h3>üîê Connexion Admin</h3>
            <p>Identifiants : admin@citil.com / admin123</p>
            <button class="btn" onclick="testAdminLogin()">Tester Connexion</button>
            <div id="login-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test des Composants Dashboard</h3>
            <div class="test-grid">
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="overview-indicator"></span>Overview</h4>
                    <button class="btn" onclick="testOverview()">Tester Overview</button>
                    <div id="overview-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="products-indicator"></span>Produits</h4>
                    <button class="btn" onclick="testProducts()">Tester Produits</button>
                    <div id="products-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="trainings-indicator"></span>Formations</h4>
                    <button class="btn" onclick="testTrainings()">Tester Formations</button>
                    <div id="trainings-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="blog-indicator"></span>Blog</h4>
                    <button class="btn" onclick="testBlog()">Tester Blog</button>
                    <div id="blog-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="categories-indicator"></span>Cat√©gories</h4>
                    <button class="btn" onclick="testCategories()">Tester Cat√©gories</button>
                    <div id="categories-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="users-indicator"></span>Utilisateurs</h4>
                    <button class="btn" onclick="testUsers()">Tester Utilisateurs</button>
                    <div id="users-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4><span class="status-indicator status-pending" id="stages-indicator"></span>Stages</h4>
                    <button class="btn" onclick="testStages()">Tester Stages</button>
                    <div id="stages-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üåê Test Interface Dashboard</h3>
            <button class="btn" onclick="loadDashboard()">Charger Dashboard</button>
            <iframe id="dashboard-iframe" class="iframe-container" src="http://localhost:3002/admin-login" style="display: none;"></iframe>
            <div id="dashboard-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Test Complet</h3>
            <button class="btn btn-success" onclick="runCompleteTest()">Lancer Test Complet</button>
            <div id="complete-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìã R√©sum√© Final</h3>
            <div id="summary-result" class="result">En attente des tests...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8002';
        const FRONTEND_URL = 'http://localhost:3002';
        let authToken = null;
        let testResults = {};

        async function makeRequest(url, options = {}) {
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3002',
                        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                return { 
                    success: response.ok, 
                    data, 
                    status: response.status, 
                    duration,
                    url: url
                };
            } catch (error) {
                const duration = Date.now() - startTime;
                return { 
                    success: false, 
                    error: error.message, 
                    duration,
                    url: url
                };
            }
        }

        function updateIndicator(testId, status) {
            const indicator = document.getElementById(`${testId}-indicator`);
            indicator.className = `status-indicator status-${status}`;
        }

        function updateResult(testId, content, type = 'info') {
            const resultDiv = document.getElementById(`${testId}-result`);
            resultDiv.innerHTML = `<div class="${type}">${content}</div>`;
        }

        async function testAdminLogin() {
            updateResult('login', 'Test de connexion admin...');
            
            try {
                const loginResult = await makeRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@citil.com',
                        password: 'admin123'
                    })
                });
                
                if (loginResult.success && loginResult.data.success) {
                    authToken = loginResult.data.token;
                    updateResult('login', `‚úÖ Connexion Admin R√©ussie
Utilisateur: ${loginResult.data.user.name}
R√¥le: ${loginResult.data.user.role}
Token: ${authToken.substring(0, 20)}...`, 'success');
                    testResults.login = { success: true, user: loginResult.data.user };
                } else {
                    updateResult('login', `‚ùå √âchec de connexion: ${loginResult.data?.message || 'Erreur inconnue'}`, 'error');
                    testResults.login = { success: false };
                }
            } catch (error) {
                updateResult('login', `‚ùå Erreur: ${error.message}`, 'error');
                testResults.login = { success: false };
            }
        }

        async function testOverview() {
            updateIndicator('overview', 'pending');
            updateResult('overview', 'Test du composant Overview...');
            
            try {
                const [products, trainings, users, applications] = await Promise.all([
                    makeRequest('/api/products'),
                    makeRequest('/api/trainings'),
                    makeRequest('/api/admin/users'),
                    makeRequest('/api/admin/internship-applications')
                ]);
                
                const allSuccess = products.success && trainings.success && users.success && applications.success;
                
                updateIndicator('overview', allSuccess ? 'success' : 'error');
                updateResult('overview', `${allSuccess ? '‚úÖ' : '‚ùå'} Composant Overview
Produits: ${products.success ? '‚úÖ' : '‚ùå'} (${products.data?.length || 0})
Formations: ${trainings.success ? '‚úÖ' : '‚ùå'} (${trainings.data?.length || 0})
Utilisateurs: ${users.success ? '‚úÖ' : '‚ùå'} (${users.data?.length || 0})
Candidatures: ${applications.success ? '‚úÖ' : '‚ùå'} (${applications.data?.length || 0})`, 
                allSuccess ? 'success' : 'error');
                
                testResults.overview = { success: allSuccess };
            } catch (error) {
                updateIndicator('overview', 'error');
                updateResult('overview', `‚ùå Erreur Overview: ${error.message}`, 'error');
                testResults.overview = { success: false };
            }
        }

        async function testProducts() {
            updateIndicator('products', 'pending');
            updateResult('products', 'Test du composant Produits...');
            
            try {
                const [products, categories] = await Promise.all([
                    makeRequest('/api/products'),
                    makeRequest('/api/categories')
                ]);
                
                const allSuccess = products.success && categories.success;
                
                updateIndicator('products', allSuccess ? 'success' : 'error');
                updateResult('products', `${allSuccess ? '‚úÖ' : '‚ùå'} Composant Produits
Liste produits: ${products.success ? '‚úÖ' : '‚ùå'} (${products.data?.length || 0})
Cat√©gories: ${categories.success ? '‚úÖ' : '‚ùå'} (${categories.data?.length || 0})`, 
                allSuccess ? 'success' : 'error');
                
                testResults.products = { success: allSuccess };
            } catch (error) {
                updateIndicator('products', 'error');
                updateResult('products', `‚ùå Erreur Produits: ${error.message}`, 'error');
                testResults.products = { success: false };
            }
        }

        async function testTrainings() {
            updateIndicator('trainings', 'pending');
            updateResult('trainings', 'Test du composant Formations...');
            
            try {
                const trainings = await makeRequest('/api/trainings');
                
                updateIndicator('trainings', trainings.success ? 'success' : 'error');
                updateResult('trainings', `${trainings.success ? '‚úÖ' : '‚ùå'} Composant Formations
Liste formations: ${trainings.success ? '‚úÖ' : '‚ùå'} (${trainings.data?.length || 0})`, 
                trainings.success ? 'success' : 'error');
                
                testResults.trainings = { success: trainings.success };
            } catch (error) {
                updateIndicator('trainings', 'error');
                updateResult('trainings', `‚ùå Erreur Formations: ${error.message}`, 'error');
                testResults.trainings = { success: false };
            }
        }

        async function testBlog() {
            updateIndicator('blog', 'pending');
            updateResult('blog', 'Test du composant Blog...');
            
            try {
                const [posts, categories] = await Promise.all([
                    makeRequest('/api/blog-posts'),
                    makeRequest('/api/blog-categories')
                ]);
                
                const allSuccess = posts.success && categories.success;
                
                updateIndicator('blog', allSuccess ? 'success' : 'error');
                updateResult('blog', `${allSuccess ? '‚úÖ' : '‚ùå'} Composant Blog
Articles: ${posts.success ? '‚úÖ' : '‚ùå'} (${posts.data?.length || 0})
Cat√©gories blog: ${categories.success ? '‚úÖ' : '‚ùå'} (${categories.data?.length || 0})`, 
                allSuccess ? 'success' : 'error');
                
                testResults.blog = { success: allSuccess };
            } catch (error) {
                updateIndicator('blog', 'error');
                updateResult('blog', `‚ùå Erreur Blog: ${error.message}`, 'error');
                testResults.blog = { success: false };
            }
        }

        async function testCategories() {
            updateIndicator('categories', 'pending');
            updateResult('categories', 'Test du composant Cat√©gories...');
            
            try {
                const categories = await makeRequest('/api/categories');
                
                updateIndicator('categories', categories.success ? 'success' : 'error');
                updateResult('categories', `${categories.success ? '‚úÖ' : '‚ùå'} Composant Cat√©gories
Liste cat√©gories: ${categories.success ? '‚úÖ' : '‚ùå'} (${categories.data?.length || 0})`, 
                categories.success ? 'success' : 'error');
                
                testResults.categories = { success: categories.success };
            } catch (error) {
                updateIndicator('categories', 'error');
                updateResult('categories', `‚ùå Erreur Cat√©gories: ${error.message}`, 'error');
                testResults.categories = { success: false };
            }
        }

        async function testUsers() {
            updateIndicator('users', 'pending');
            updateResult('users', 'Test du composant Utilisateurs...');
            
            try {
                const users = await makeRequest('/api/admin/users');
                
                updateIndicator('users', users.success ? 'success' : 'error');
                updateResult('users', `${users.success ? '‚úÖ' : '‚ùå'} Composant Utilisateurs
Liste utilisateurs: ${users.success ? '‚úÖ' : '‚ùå'} (${users.data?.length || 0})`, 
                users.success ? 'success' : 'error');
                
                testResults.users = { success: users.success };
            } catch (error) {
                updateIndicator('users', 'error');
                updateResult('users', `‚ùå Erreur Utilisateurs: ${error.message}`, 'error');
                testResults.users = { success: false };
            }
        }

        async function testStages() {
            updateIndicator('stages', 'pending');
            updateResult('stages', 'Test du composant Stages...');
            
            try {
                const applications = await makeRequest('/api/admin/internship-applications');
                
                updateIndicator('stages', applications.success ? 'success' : 'error');
                updateResult('stages', `${applications.success ? '‚úÖ' : '‚ùå'} Composant Stages
Candidatures: ${applications.success ? '‚úÖ' : '‚ùå'} (${applications.data?.length || 0})`, 
                applications.success ? 'success' : 'error');
                
                testResults.stages = { success: applications.success };
            } catch (error) {
                updateIndicator('stages', 'error');
                updateResult('stages', `‚ùå Erreur Stages: ${error.message}`, 'error');
                testResults.stages = { success: false };
            }
        }

        async function loadDashboard() {
            const resultDiv = document.getElementById('dashboard-result');
            resultDiv.textContent = 'Chargement du dashboard...';
            
            try {
                const response = await fetch(`${FRONTEND_URL}/admin-login`, { method: 'HEAD' });
                
                if (response.ok) {
                    document.getElementById('dashboard-iframe').style.display = 'block';
                    resultDiv.innerHTML = `<div class="success">‚úÖ Dashboard Charg√©
URL: ${FRONTEND_URL}/admin-login
Status: ${response.status}
Instructions: Connectez-vous avec admin@citil.com / admin123</div>`;
                    testResults.dashboard = { success: true, status: response.status };
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Dashboard inaccessible (Status: ${response.status})</div>`;
                    testResults.dashboard = { success: false };
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur dashboard: ${error.message}</div>`;
                testResults.dashboard = { success: false };
            }
        }

        async function runCompleteTest() {
            const resultDiv = document.getElementById('complete-result');
            resultDiv.textContent = 'Lancement du test complet...';
            
            // Ex√©cuter tous les tests
            await testAdminLogin();
            await testOverview();
            await testProducts();
            await testTrainings();
            await testBlog();
            await testCategories();
            await testUsers();
            await testStages();
            await loadDashboard();
            
            // Calculer le r√©sum√©
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success).length;
            const successRate = totalTests > 0 ? (successfulTests / totalTests * 100).toFixed(1) : 0;
            
            resultDiv.innerHTML = `<div class="${successRate >= 80 ? 'success' : 'error'}">üéâ Test Complet Termin√©
Tests ex√©cut√©s: ${totalTests}
Tests r√©ussis: ${successfulTests}
Taux de r√©ussite: ${successRate}%
Status: ${successRate >= 80 ? '‚úÖ EXCELLENT' : successRate >= 60 ? '‚ö†Ô∏è ACCEPTABLE' : '‚ùå PROBL√âMATIQUE'}</div>`;
            
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary-result');
            
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success).length;
            const successRate = totalTests > 0 ? (successfulTests / totalTests * 100).toFixed(1) : 0;
            
            let summary = `üìä R√âSUM√â FINAL DASHBOARD ADMIN\n`;
            summary += `Tests ex√©cut√©s: ${totalTests}\n`;
            summary += `Tests r√©ussis: ${successfulTests}\n`;
            summary += `Taux de r√©ussite: ${successRate}%\n\n`;
            
            if (successRate >= 80) {
                summary += `‚úÖ DASHBOARD ADMIN: 100% FONCTIONNEL\n`;
                summary += `Tous les composants s'affichent et fonctionnent correctement.\n`;
                summary += `Le blog et toutes les options du dashboard sont op√©rationnels.`;
            } else if (successRate >= 60) {
                summary += `‚ö†Ô∏è DASHBOARD ADMIN: FONCTIONNEL AVEC R√âSERVES\n`;
                summary += `La plupart des composants fonctionnent, mais quelques probl√®mes d√©tect√©s.\n`;
                summary += `V√©rifiez les logs pour plus de d√©tails.`;
            } else {
                summary += `‚ùå DASHBOARD ADMIN: PROBL√âMATIQUE\n`;
                summary += `Des probl√®mes majeurs emp√™chent l'affichage des composants.\n`;
                summary += `Red√©marrez les services et v√©rifiez la configuration.`;
            }
            
            summaryDiv.textContent = summary;
        }

        // Test automatique au chargement
        window.onload = function() {
            loadDashboard();
        };
    </script>
</body>
</html>

