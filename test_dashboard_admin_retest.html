<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retest Dashboard Admin - CITIL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffeaea; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .btn { background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #1976d2; }
        .btn-success { background: #4caf50; }
        .btn-warning { background: #ff9800; }
        .btn-danger { background: #f44336; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .dashboard-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fafafa; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .metric:last-child { border-bottom: none; }
        .metric-value { font-weight: bold; color: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Retest Dashboard Administrateur - CITIL</h1>
        <p><strong>Objectif :</strong> V√©rifier que toutes les fonctionnalit√©s du dashboard administrateur fonctionnent parfaitement.</p>
        
        <div class="test-section info">
            <h3>üìä Dashboard Overview</h3>
            <div class="dashboard-grid">
                <div class="dashboard-item">
                    <h4>üì¶ Produits</h4>
                    <div id="products-metrics" class="result">Chargement...</div>
                </div>
                <div class="dashboard-item">
                    <h4>üéì Formations</h4>
                    <div id="trainings-metrics" class="result">Chargement...</div>
                </div>
                <div class="dashboard-item">
                    <h4>üë• Utilisateurs</h4>
                    <div id="users-metrics" class="result">Chargement...</div>
                </div>
                <div class="dashboard-item">
                    <h4>üìù Candidatures</h4>
                    <div id="applications-metrics" class="result">Chargement...</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üîê Test d'Authentification</h3>
            <button class="btn" onclick="testAdminAuth()">Tester Connexion Admin</button>
            <div id="auth-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Test des Op√©rations CRUD</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <h4>Produits</h4>
                    <button class="btn" onclick="testProductsCRUD()">Tester CRUD Produits</button>
                    <div id="products-crud-result" class="result"></div>
                </div>
                <div>
                    <h4>Formations</h4>
                    <button class="btn" onclick="testTrainingsCRUD()">Tester CRUD Formations</button>
                    <div id="trainings-crud-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìà Test de Performance</h3>
            <button class="btn" onclick="testPerformance()">Tester Performance</button>
            <div id="performance-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Test Interface Utilisateur</h3>
            <button class="btn" onclick="testUI()">Tester Interface</button>
            <div id="ui-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>‚ö†Ô∏è Test de Gestion d'Erreurs</h3>
            <button class="btn" onclick="testErrorHandling()">Tester Gestion Erreurs</button>
            <div id="error-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Test Complet Dashboard</h3>
            <button class="btn btn-success" onclick="runCompleteDashboardTest()">Lancer Test Complet</button>
            <div id="complete-test-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìã R√©sum√© des Tests</h3>
            <div id="summary-result" class="result">En attente des tests...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8002';
        const FRONTEND_URL = 'http://localhost:3002';
        let authToken = null;
        let testResults = {};

        async function makeRequest(url, options = {}) {
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3002',
                        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                return { 
                    success: response.ok, 
                    data, 
                    status: response.status, 
                    duration,
                    url: url
                };
            } catch (error) {
                const duration = Date.now() - startTime;
                return { 
                    success: false, 
                    error: error.message, 
                    duration,
                    url: url
                };
            }
        }

        async function loadDashboardMetrics() {
            try {
                const [products, trainings, users, applications] = await Promise.all([
                    makeRequest('/api/products'),
                    makeRequest('/api/trainings'),
                    makeRequest('/api/admin/users'),
                    makeRequest('/api/admin/internship-applications')
                ]);

                // Afficher les m√©triques des produits
                const productsCount = products.success ? products.data.length : 0;
                document.getElementById('products-metrics').innerHTML = `
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">${productsCount}</span>
                    </div>
                    <div class="metric">
                        <span>Status:</span>
                        <span class="metric-value">${products.success ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric">
                        <span>Temps:</span>
                        <span class="metric-value">${products.duration}ms</span>
                    </div>
                `;

                // Afficher les m√©triques des formations
                const trainingsCount = trainings.success ? trainings.data.length : 0;
                document.getElementById('trainings-metrics').innerHTML = `
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">${trainingsCount}</span>
                    </div>
                    <div class="metric">
                        <span>Status:</span>
                        <span class="metric-value">${trainings.success ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric">
                        <span>Temps:</span>
                        <span class="metric-value">${trainings.duration}ms</span>
                    </div>
                `;

                // Afficher les m√©triques des utilisateurs
                const usersCount = users.success ? users.data.length : 0;
                document.getElementById('users-metrics').innerHTML = `
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">${usersCount}</span>
                    </div>
                    <div class="metric">
                        <span>Status:</span>
                        <span class="metric-value">${users.success ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric">
                        <span>Temps:</span>
                        <span class="metric-value">${users.duration}ms</span>
                    </div>
                `;

                // Afficher les m√©triques des candidatures
                const applicationsCount = applications.success ? applications.data.length : 0;
                document.getElementById('applications-metrics').innerHTML = `
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">${applicationsCount}</span>
                    </div>
                    <div class="metric">
                        <span>Status:</span>
                        <span class="metric-value">${applications.success ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric">
                        <span>Temps:</span>
                        <span class="metric-value">${applications.duration}ms</span>
                    </div>
                `;

                testResults.metrics = {
                    success: products.success && trainings.success && users.success && applications.success,
                    data: { products: productsCount, trainings: trainingsCount, users: usersCount, applications: applicationsCount }
                };

            } catch (error) {
                console.error('Erreur lors du chargement des m√©triques:', error);
            }
        }

        async function testAdminAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.textContent = 'Test d\'authentification admin...';
            
            try {
                const loginResult = await makeRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@citil.com',
                        password: 'admin123'
                    })
                });
                
                if (loginResult.success && loginResult.data.success) {
                    authToken = loginResult.data.token;
                    
                    const meResult = await makeRequest('/api/auth/me');
                    
                    if (meResult.success && meResult.data.user) {
                        resultDiv.innerHTML = `<div class="success">‚úÖ Authentification Admin R√©ussie
Utilisateur: ${meResult.data.user.name}
R√¥le: ${meResult.data.user.role}
Email: ${meResult.data.user.email}
Token: ${authToken.substring(0, 20)}...</div>`;
                        testResults.auth = { success: true, user: meResult.data.user };
                    } else {
                        resultDiv.innerHTML = `<div class="error">‚ùå Connexion r√©ussie mais v√©rification √©chou√©e</div>`;
                        testResults.auth = { success: false };
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå √âchec de connexion: ${loginResult.data?.message || 'Erreur inconnue'}</div>`;
                    testResults.auth = { success: false };
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur lors du test: ${error.message}</div>`;
                testResults.auth = { success: false };
            }
        }

        async function testProductsCRUD() {
            const resultDiv = document.getElementById('products-crud-result');
            resultDiv.textContent = 'Test CRUD Produits...';
            
            try {
                // Test de lecture
                const getProducts = await makeRequest('/api/products');
                
                // Test de cr√©ation
                const createProduct = await makeRequest('/api/admin/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'Test CRUD Produit',
                        description: 'Test CRUD description',
                        price: 25000,
                        stock: 5,
                        category_id: 1,
                        reference: 'CRUD-TEST-001'
                    })
                });
                
                // Test de lecture des cat√©gories
                const getCategories = await makeRequest('/api/categories');
                
                const allSuccess = getProducts.success && createProduct.success && getCategories.success;
                
                resultDiv.innerHTML = `<div class="${allSuccess ? 'success' : 'error'}">${allSuccess ? '‚úÖ' : '‚ùå'} Test CRUD Produits
Lecture: ${getProducts.success ? '‚úÖ' : '‚ùå'} (${getProducts.data?.length || 0} produits)
Cr√©ation: ${createProduct.success ? '‚úÖ' : '‚ùå'}
Cat√©gories: ${getCategories.success ? '‚úÖ' : '‚ùå'} (${getCategories.data?.length || 0} cat√©gories)</div>`;
                
                testResults.productsCRUD = { success: allSuccess };
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur CRUD Produits: ${error.message}</div>`;
                testResults.productsCRUD = { success: false };
            }
        }

        async function testTrainingsCRUD() {
            const resultDiv = document.getElementById('trainings-crud-result');
            resultDiv.textContent = 'Test CRUD Formations...';
            
            try {
                // Test de lecture
                const getTrainings = await makeRequest('/api/trainings');
                
                // Test de cr√©ation
                const createTraining = await makeRequest('/api/admin/trainings', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: 'Test CRUD Formation',
                        description: 'Test CRUD formation description',
                        price: 35000,
                        duration_hours: 16,
                        start_date: '2025-12-20',
                        schedule: '9h-17h'
                    })
                });
                
                const allSuccess = getTrainings.success && createTraining.success;
                
                resultDiv.innerHTML = `<div class="${allSuccess ? 'success' : 'error'}">${allSuccess ? '‚úÖ' : '‚ùå'} Test CRUD Formations
Lecture: ${getTrainings.success ? '‚úÖ' : '‚ùå'} (${getTrainings.data?.length || 0} formations)
Cr√©ation: ${createTraining.success ? '‚úÖ' : '‚ùå'}</div>`;
                
                testResults.trainingsCRUD = { success: allSuccess };
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur CRUD Formations: ${error.message}</div>`;
                testResults.trainingsCRUD = { success: false };
            }
        }

        async function testPerformance() {
            const resultDiv = document.getElementById('performance-result');
            resultDiv.textContent = 'Test de performance...';
            
            try {
                const startTime = Date.now();
                
                // Test de charge - 10 requ√™tes simultan√©es
                const promises = [];
                for (let i = 0; i < 10; i++) {
                    promises.push(makeRequest('/api/products'));
                }
                
                const results = await Promise.all(promises);
                const endTime = Date.now();
                const totalDuration = endTime - startTime;
                
                const successCount = results.filter(r => r.success).length;
                const avgDuration = results.reduce((sum, r) => sum + r.duration, 0) / results.length;
                const maxDuration = Math.max(...results.map(r => r.duration));
                
                const performance = avgDuration < 500 ? 'excellent' : avgDuration < 1000 ? 'bon' : 'm√©diocre';
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Test de Performance
Requ√™tes simultan√©es: ${successCount}/10 r√©ussies
Dur√©e totale: ${totalDuration}ms
Dur√©e moyenne: ${avgDuration.toFixed(0)}ms
Dur√©e max: ${maxDuration}ms
Performance: ${performance}</div>`;
                
                testResults.performance = { 
                    success: successCount >= 8, 
                    successCount, 
                    totalDuration, 
                    avgDuration, 
                    maxDuration 
                };
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur test performance: ${error.message}</div>`;
                testResults.performance = { success: false };
            }
        }

        async function testUI() {
            const resultDiv = document.getElementById('ui-result');
            resultDiv.textContent = 'Test interface utilisateur...';
            
            try {
                const frontendResponse = await fetch(FRONTEND_URL, { method: 'HEAD' });
                
                if (frontendResponse.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Interface Utilisateur
Frontend accessible: ‚úÖ (Status: ${frontendResponse.status})
URL: ${FRONTEND_URL}
Interface: Op√©rationnelle</div>`;
                    testResults.ui = { success: true, status: frontendResponse.status };
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Frontend inaccessible (Status: ${frontendResponse.status})</div>`;
                    testResults.ui = { success: false };
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur interface: ${error.message}</div>`;
                testResults.ui = { success: false };
            }
        }

        async function testErrorHandling() {
            const resultDiv = document.getElementById('error-result');
            resultDiv.textContent = 'Test gestion d\'erreurs...';
            
            try {
                const errorTests = [
                    { name: 'Endpoint Inexistant', url: '/api/nonexistent', expectedError: true },
                    { name: 'M√©thode Non Autoris√©e', url: '/api/products', method: 'DELETE', expectedError: true },
                    { name: 'Donn√©es Invalides', url: '/api/auth/login', method: 'POST', data: { email: 'invalid', password: 'wrong' }, expectedError: true }
                ];
                
                let results = [];
                
                for (const test of errorTests) {
                    const options = { method: test.method || 'GET' };
                    if (test.data) {
                        options.body = JSON.stringify(test.data);
                    }
                    
                    const result = await makeRequest(test.url, options);
                    const hasError = !result.success;
                    const expectedError = test.expectedError;
                    const status = (hasError === expectedError) ? '‚úÖ' : '‚ùå';
                    results.push(`${status} ${test.name}`);
                }
                
                const allPassed = results.every(r => r.includes('‚úÖ'));
                
                resultDiv.innerHTML = `<div class="${allPassed ? 'success' : 'error'}">${allPassed ? '‚úÖ' : '‚ùå'} Gestion d'Erreurs
${results.join('\n')}</div>`;
                
                testResults.errorHandling = { success: allPassed };
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur test gestion erreurs: ${error.message}</div>`;
                testResults.errorHandling = { success: false };
            }
        }

        async function runCompleteDashboardTest() {
            const resultDiv = document.getElementById('complete-test-result');
            resultDiv.textContent = 'Lancement du test complet du dashboard...';
            
            // Charger les m√©triques
            await loadDashboardMetrics();
            
            // Ex√©cuter tous les tests
            await testAdminAuth();
            await testProductsCRUD();
            await testTrainingsCRUD();
            await testPerformance();
            await testUI();
            await testErrorHandling();
            
            // Calculer le r√©sum√©
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success).length;
            const successRate = totalTests > 0 ? (successfulTests / totalTests * 100).toFixed(1) : 0;
            
            resultDiv.innerHTML = `<div class="${successRate >= 80 ? 'success' : 'error'}">üéâ Test Complet Dashboard Termin√©
Tests ex√©cut√©s: ${totalTests}
Tests r√©ussis: ${successfulTests}
Taux de r√©ussite: ${successRate}%
Status: ${successRate >= 80 ? '‚úÖ EXCELLENT' : successRate >= 60 ? '‚ö†Ô∏è ACCEPTABLE' : '‚ùå PROBL√âMATIQUE'}</div>`;
            
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary-result');
            
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success).length;
            const successRate = totalTests > 0 ? (successfulTests / totalTests * 100).toFixed(1) : 0;
            
            let summary = `üìä R√âSUM√â DASHBOARD ADMINISTRATEUR\n`;
            summary += `Tests ex√©cut√©s: ${totalTests}\n`;
            summary += `Tests r√©ussis: ${successfulTests}\n`;
            summary += `Taux de r√©ussite: ${successRate}%\n\n`;
            
            if (testResults.metrics) {
                summary += `üìà M√âTRIQUES:\n`;
                summary += `Produits: ${testResults.metrics.data.products}\n`;
                summary += `Formations: ${testResults.metrics.data.trainings}\n`;
                summary += `Utilisateurs: ${testResults.metrics.data.users}\n`;
                summary += `Candidatures: ${testResults.metrics.data.applications}\n\n`;
            }
            
            if (successRate >= 80) {
                summary += `‚úÖ DASHBOARD ADMIN: OP√âRATIONNEL\n`;
                summary += `Toutes les fonctionnalit√©s du dashboard administrateur fonctionnent correctement.\n`;
                summary += `L'interface est pr√™te pour la production.`;
            } else if (successRate >= 60) {
                summary += `‚ö†Ô∏è DASHBOARD ADMIN: FONCTIONNEL AVEC R√âSERVES\n`;
                summary += `La plupart des fonctionnalit√©s fonctionnent, mais quelques probl√®mes mineurs d√©tect√©s.\n`;
                summary += `V√©rifiez les logs pour plus de d√©tails.`;
            } else {
                summary += `‚ùå DASHBOARD ADMIN: PROBL√âMATIQUE\n`;
                summary += `Le dashboard a des probl√®mes majeurs qui n√©cessitent une attention imm√©diate.\n`;
                summary += `Red√©marrez les services et v√©rifiez la configuration.`;
            }
            
            summaryDiv.textContent = summary;
        }

        // Chargement automatique des m√©triques au d√©marrage
        window.onload = function() {
            loadDashboardMetrics();
        };
    </script>
</body>
</html>
