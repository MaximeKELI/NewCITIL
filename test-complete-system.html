<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Syst√®me Complet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        .warning { background: #fff3cd; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üîç Test Complet du Syst√®me</h1>
    
    <div class="test info">
        <h3>√âtat des serveurs</h3>
        <button onclick="checkAllServices()">V√©rifier tous les services</button>
        <div id="servicesResult"></div>
    </div>
    
    <div class="test info">
        <h3>Test de connexion base de donn√©es</h3>
        <button onclick="testDatabase()">Tester la base de donn√©es</button>
        <div id="databaseResult"></div>
    </div>
    
    <div class="test info">
        <h3>Test de l'API Backend</h3>
        <button onclick="testBackendAPI()">Tester l'API Backend</button>
        <div id="backendResult"></div>
    </div>
    
    <div class="test info">
        <h3>Test du Frontend</h3>
        <button onclick="testFrontend()">Tester le Frontend</button>
        <div id="frontendResult"></div>
    </div>
    
    <div class="test info">
        <h3>Test de connexion Frontend-Backend</h3>
        <button onclick="testFrontendBackendConnection()">Tester la connexion</button>
        <div id="connectionResult"></div>
    </div>
    
    <div class="test info">
        <h3>Test complet du flux admin</h3>
        <button onclick="testAdminFlow()">Tester le flux admin complet</button>
        <div id="adminFlowResult"></div>
    </div>

    <script>
        async function checkAllServices() {
            const result = document.getElementById('servicesResult');
            result.innerHTML = '<div class="info">üîÑ V√©rification des services...</div>';
            
            let services = [];
            
            // V√©rifier Backend Laravel
            try {
                const backendResponse = await fetch('http://localhost:8000/api/products');
                if (backendResponse.ok) {
                    services.push('<span class="status status-ok">‚úÖ Backend Laravel (Port 8000)</span>');
                } else {
                    services.push('<span class="status status-error">‚ùå Backend Laravel (Port 8000) - Erreur ' + backendResponse.status + '</span>');
                }
            } catch (error) {
                services.push('<span class="status status-error">‚ùå Backend Laravel (Port 8000) - Inaccessible</span>');
            }
            
            // V√©rifier Frontend React
            try {
                const frontendResponse = await fetch('http://localhost:3000');
                if (frontendResponse.ok) {
                    services.push('<span class="status status-ok">‚úÖ Frontend React (Port 3000)</span>');
                } else {
                    services.push('<span class="status status-error">‚ùå Frontend React (Port 3000) - Erreur ' + frontendResponse.status + '</span>');
                }
            } catch (error) {
                services.push('<span class="status status-error">‚ùå Frontend React (Port 3000) - Inaccessible</span>');
            }
            
            result.innerHTML = '<h4>Services:</h4>' + services.join('<br>');
        }
        
        async function testDatabase() {
            const result = document.getElementById('databaseResult');
            result.innerHTML = '<div class="info">üîÑ Test de la base de donn√©es...</div>';
            
            try {
                // Test de connexion via l'API
                const response = await fetch('http://localhost:8000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@citil.tg',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Base de donn√©es accessible</h4>
                            <p><strong>Utilisateur admin trouv√©:</strong> ${data.user_info.name} (${data.user_info.email})</p>
                            <p><strong>R√¥le:</strong> ${data.user_info.role}</p>
                            <p><strong>Token g√©n√©r√©:</strong> ${data.token ? 'Oui' : 'Non'}</p>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erreur de base de donn√©es</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erreur de connexion: ${error.message}</div>`;
            }
        }
        
        async function testBackendAPI() {
            const result = document.getElementById('backendResult');
            result.innerHTML = '<div class="info">üîÑ Test de l\'API Backend...</div>';
            
            let tests = [];
            
            // Test 1: Route publique
            try {
                const publicResponse = await fetch('http://localhost:8000/api/products');
                if (publicResponse.ok) {
                    tests.push('<span class="status status-ok">‚úÖ Route publique /api/products</span>');
                } else {
                    tests.push('<span class="status status-error">‚ùå Route publique /api/products - Erreur ' + publicResponse.status + '</span>');
                }
            } catch (error) {
                tests.push('<span class="status status-error">‚ùå Route publique /api/products - Inaccessible</span>');
            }
            
            // Test 2: Authentification
            try {
                const authResponse = await fetch('http://localhost:8000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@citil.tg',
                        password: 'password123'
                    })
                });
                
                if (authResponse.ok) {
                    tests.push('<span class="status status-ok">‚úÖ Authentification /api/login</span>');
                    
                    const authData = await authResponse.json();
                    const token = authData.token;
                    
                    // Test 3: Route prot√©g√©e
                    try {
                        const protectedResponse = await fetch('http://localhost:8000/api/admin/products', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (protectedResponse.ok) {
                            tests.push('<span class="status status-ok">‚úÖ Route prot√©g√©e /api/admin/products</span>');
                        } else {
                            tests.push('<span class="status status-error">‚ùå Route prot√©g√©e /api/admin/products - Erreur ' + protectedResponse.status + '</span>');
                        }
                    } catch (error) {
                        tests.push('<span class="status status-error">‚ùå Route prot√©g√©e /api/admin/products - Inaccessible</span>');
                    }
                } else {
                    tests.push('<span class="status status-error">‚ùå Authentification /api/login - Erreur</span>');
                }
            } catch (error) {
                tests.push('<span class="status status-error">‚ùå Authentification /api/login - Inaccessible</span>');
            }
            
            result.innerHTML = '<h4>Tests API Backend:</h4>' + tests.join('<br>');
        }
        
        async function testFrontend() {
            const result = document.getElementById('frontendResult');
            result.innerHTML = '<div class="info">üîÑ Test du Frontend...</div>';
            
            let tests = [];
            
            // Test 1: Page d'accueil
            try {
                const homeResponse = await fetch('http://localhost:3000');
                if (homeResponse.ok) {
                    tests.push('<span class="status status-ok">‚úÖ Page d\'accueil accessible</span>');
                    
                    const html = await homeResponse.text();
                    if (html.includes('id="root"')) {
                        tests.push('<span class="status status-ok">‚úÖ React root d√©tect√©</span>');
                    } else {
                        tests.push('<span class="status status-warning">‚ö†Ô∏è React root non d√©tect√©</span>');
                    }
                } else {
                    tests.push('<span class="status status-error">‚ùå Page d\'accueil - Erreur ' + homeResponse.status + '</span>');
                }
            } catch (error) {
                tests.push('<span class="status status-error">‚ùå Page d\'accueil - Inaccessible</span>');
            }
            
            // Test 2: Page de connexion
            try {
                const loginResponse = await fetch('http://localhost:3000/login');
                if (loginResponse.ok) {
                    tests.push('<span class="status status-ok">‚úÖ Page de connexion accessible</span>');
                } else {
                    tests.push('<span class="status status-error">‚ùå Page de connexion - Erreur ' + loginResponse.status + '</span>');
                }
            } catch (error) {
                tests.push('<span class="status status-error">‚ùå Page de connexion - Inaccessible</span>');
            }
            
            // Test 3: Page admin
            try {
                const adminResponse = await fetch('http://localhost:3000/admin');
                if (adminResponse.ok) {
                    tests.push('<span class="status status-ok">‚úÖ Page admin accessible</span>');
                } else {
                    tests.push('<span class="status status-error">‚ùå Page admin - Erreur ' + adminResponse.status + '</span>');
                }
            } catch (error) {
                tests.push('<span class="status status-error">‚ùå Page admin - Inaccessible</span>');
            }
            
            result.innerHTML = '<h4>Tests Frontend:</h4>' + tests.join('<br>');
        }
        
        async function testFrontendBackendConnection() {
            const result = document.getElementById('connectionResult');
            result.innerHTML = '<div class="info">üîÑ Test de connexion Frontend-Backend...</div>';
            
            try {
                // Simuler une connexion depuis le frontend
                const response = await fetch('http://localhost:8000/api/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@citil.tg',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Stocker les donn√©es comme le ferait le frontend
                    localStorage.setItem('citil_token', data.token);
                    localStorage.setItem('citil_user', JSON.stringify(data.user_info));
                    
                    result.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Connexion Frontend-Backend r√©ussie</h4>
                            <p><strong>Token stock√©:</strong> ${data.token ? 'Oui' : 'Non'}</p>
                            <p><strong>Utilisateur stock√©:</strong> ${data.user_info.name} (${data.user_info.role})</p>
                            <p><strong>Redirection attendue:</strong> ${data.user_info.role === 'admin' ? '/admin' : '/'}</p>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erreur de connexion Frontend-Backend</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erreur de connexion: ${error.message}</div>`;
            }
        }
        
        async function testAdminFlow() {
            const result = document.getElementById('adminFlowResult');
            result.innerHTML = '<div class="info">üîÑ Test du flux admin complet...</div>';
            
            try {
                // √âtape 1: Connexion admin
                const loginResponse = await fetch('http://localhost:8000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@citil.tg',
                        password: 'password123'
                    })
                });
                
                const loginData = await loginResponse.json();
                
                if (!loginResponse.ok) {
                    result.innerHTML = `<div class="error">‚ùå √âchec de la connexion admin: ${loginData.message}</div>`;
                    return;
                }
                
                // √âtape 2: V√©rification du r√¥le
                if (loginData.user_info.role !== 'admin') {
                    result.innerHTML = `<div class="error">‚ùå Utilisateur non admin: ${loginData.user_info.role}</div>`;
                    return;
                }
                
                // √âtape 3: Test des routes admin
                const token = loginData.token;
                const adminRoutes = [
                    '/api/admin/products',
                    '/api/admin/categories',
                    '/api/admin/trainings',
                    '/api/user'
                ];
                
                let routeTests = [];
                
                for (const route of adminRoutes) {
                    try {
                        const routeResponse = await fetch(`http://localhost:8000${route}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (routeResponse.ok) {
                            routeTests.push(`<span class="status status-ok">‚úÖ ${route}</span>`);
                        } else {
                            routeTests.push(`<span class="status status-error">‚ùå ${route} - Erreur ${routeResponse.status}</span>`);
                        }
                    } catch (error) {
                        routeTests.push(`<span class="status status-error">‚ùå ${route} - Inaccessible</span>`);
                    }
                }
                
                // √âtape 4: Test de la page admin frontend
                try {
                    const adminPageResponse = await fetch('http://localhost:3000/admin');
                    if (adminPageResponse.ok) {
                        routeTests.push('<span class="status status-ok">‚úÖ Page admin frontend accessible</span>');
                    } else {
                        routeTests.push('<span class="status status-error">‚ùå Page admin frontend - Erreur ' + adminPageResponse.status + '</span>');
                    }
                } catch (error) {
                    routeTests.push('<span class="status status-error">‚ùå Page admin frontend - Inaccessible</span>');
                }
                
                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Flux admin complet test√©</h4>
                        <p><strong>Utilisateur admin:</strong> ${loginData.user_info.name} (${loginData.user_info.email})</p>
                        <p><strong>Token:</strong> ${token ? 'G√©n√©r√©' : 'Non g√©n√©r√©'}</p>
                        <h5>Tests des routes:</h5>
                        ${routeTests.join('<br>')}
                        <p><strong>Instructions de test manuel:</strong></p>
                        <ol>
                            <li>Allez sur <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
                            <li>Cliquez sur le bouton "Tester Connexion Admin" en bas √† droite</li>
                            <li>V√©rifiez que vous √™tes redirig√© vers /admin</li>
                        </ol>
                    </div>
                `;
                
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erreur lors du test du flux admin: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
